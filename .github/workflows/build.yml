name: Build and Publish myNginx Image

on:
  schedule:
    - cron: "0 3 * * *"
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y curl jq

      - name: Get latest versions
        run: bash scripts/get-latest.sh

      - name: Show detected versions
        run: echo "Nginx=${{ env.NGINX_VERSION }}, OpenSSL=${{ env.OPENSSL_VERSION }}"

      - name: Show latest nginx-full configure flags
        run: bash scripts/extract-nginx-flags.sh && echo "Nginx-full configure flags=${{ env.NGINX_CONFIGURE_FLAGS }}"

      - name: Build Docker image
        run: |
          docker build \
            --build-arg NGINX_VERSION=${{ env.NGINX_VERSION }} \
            --build-arg OPENSSL_VERSION=${{ env.OPENSSL_VERSION }} \
            --build-arg NGINX_CONFIGURE_FLAGS=${{ env.NGINX_CONFIGURE_FLAGS }} \
            -t ghcr.io/${{ github.repository_owner }}/myNginx:latest \
            -t ghcr.io/${{ github.repository_owner }}/myNginx:${{ env.NGINX_VERSION }} \
            ./docker

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      - name: Push Docker images
        run: |
          docker push ghcr.io/${{ github.repository_owner }}/myNginx:${{ env.NGINX_VERSION }}
          docker push ghcr.io/${{ github.repository_owner }}/myNginx:latest
